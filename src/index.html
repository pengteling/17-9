<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>HTML5拖动文件上传...</title>
    <style type="text/css">
    .container {
        width: 800px;
        height: 200px;
        line-height: 200px;
        text-align: center;
        border: #333 2px dashed;
    }
    </style>
</head>

<body>
    <div class="container">请将文件拖入此区域</div>
    <div class="preview"></div>
    <script type="text/javascript">
    var container = document.querySelector(".container");
    var preview = document.querySelector(".preview");

    console.log(container);
    container.ondragover = function(e) {
        e.preventDefault();
    }
    container.ondrop = function(e) {
        e.preventDefault();
        console.log(e.dataTransfer.files);
        handleFiles(e.dataTransfer.files);
    }

    //var uploads = [];
    function handleFiles(files) {

        for (let i = 0; i < files.length; i++) {
            var file = files[i];
            console.log(file);
            //只上传图片文件
            if (!file.type.match(/image*/)) {
                continue;
            }

            var img = document.createElement("img");
            img.classList.add("imgpreview");
            img.file = file;
            preview.appendChild(img);

            var reader = new FileReader();
            reader.onload =  function(e) { 
            	img.src = e.target.result; 
            }; 
            reader.readAsDataURL(file);

            var reader2 = new FileReader();
            reader2.readAsBinaryString(file);
			var filebinary;
			
			reader2.onload = function(e){
				//console.log(e.target.result)
            	filebinary = e.target.result
            	//uploads[i] = filebinary;
            	xhrUpload(filebinary)
			}

        }
    }

    function xhrUpload(filebinary){
    	let xhr = new XMLHttpRequest();
        xhr.open("post", "http://localhost:276/web/meitu/upload.asp", true);
		Array.prototype.sendAsBinary = XMLHttpRequest.prototype.sendAsBinary = function(datastr) {
            function byteValue(x) {
                return x.charCodeAt(0) & 0xff;
            }
            var ords = Array.prototype.map.call(datastr, byteValue);
            var ui8a = new Uint8Array(ords);
            this.send(ui8a.buffer);
        }
		xhr.sendAsBinary(filebinary);
        // setTimeout(
        // 	function(){
        // 		xhr.sendAsBinary(filebinary);
        // 	}
        // 	,1000);
        xhr.onreadystatechange = function(){
        	if(xhr.readyState==4){
        		if(xhr.status==200){
        			console.log("上传成功")
        			//continue;
        			//break;
        		}
        	}
        }


        
    }
    </script>
</body>

</html>